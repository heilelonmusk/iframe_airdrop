/*******************************************************
 * airdrop_checker.js
 * Definitive script for Helon Airdrop Checker
 *******************************************************/

/**
 * Funzione principale che viene chiamata dal pulsante "Verify".
 * 1. Controlla se l’input wallet è vuoto (effetto shake).
 * 2. Scarica la whitelist.csv da GitHub (via jsDelivr).
 * 3. Verifica se il wallet è presente in whitelist:
 *    - Se sì, effetto confetti + dispatch "update_whitelist".
 *    - Se no, effetto shake + dispatch "update_noneligible".
 */
 async function checkAirdrop() {
  const walletInput = document.getElementById("walletInput");
  const wallet = walletInput.value.trim();
  const resultElem = document.getElementById("result");
  const container = document.querySelector(".checker-container");

  // 1. Se non inserisce il wallet, effetto shake e messaggio di errore
  if (!wallet) {
    resultElem.innerText = "⚠️ Please enter a valid wallet address.";
    container.classList.add("shake");
    walletInput.classList.add("input-error");
    setTimeout(() => {
      container.classList.remove("shake");
      walletInput.classList.remove("input-error");
    }, 700);
    return;
  }
  
  try {
    // 2. Scarica la whitelist.csv
    const response = await fetch("https://cdn.jsdelivr.net/gh/heilelonmusk/iframe_airdrop@main/data/whitelist.csv");
    if (!response.ok) {
      throw new Error("Network response was not ok");
    }

    // 3. Analizza il CSV e cerca il wallet
    const csvText = await response.text();
    const rows = csvText.split("\n").filter(line => line.trim() !== "");
    // Preleva l'indice della colonna "wallet address"
    const header = rows[0].split(",").map(h => h.trim().toLowerCase());
    const walletIndex = header.indexOf("wallet address");
    let isWhitelisted = false;

    for (let i = 1; i < rows.length; i++) {
      const cols = rows[i].split(",").map(col => col.trim());
      if (cols[walletIndex] && cols[walletIndex].toLowerCase() === wallet.toLowerCase()) {
        isWhitelisted = true;
        break;
      }
    }

    // 4. Se wallet whitelisted
    if (isWhitelisted) {
      resultElem.innerHTML = "✅ You are eligible!<br>Final airdrop details will be announced by 23:59 CET on Feb. 28.";
      triggerWorkflow(wallet, "update_whitelist");

      // Effetto confetti
      if (typeof confetti === "function") {
        confetti({
          particleCount: 150,
          spread: 100,
          origin: { y: 0.6 }
        });
      }
    } 
    // 5. Se wallet non whitelisted
    else {
      resultElem.innerText = "❌ Not whitelisted, but stay tuned for future opportunities! Join our community channels for updates.";
      container.classList.add("shake");
      setTimeout(() => {
        container.classList.remove("shake");
      }, 700);

      triggerWorkflow(wallet, "update_noneligible");
    }
  } catch (error) {
    resultElem.innerText = "⚠️ Error checking whitelist. Please try again later.";
    console.error(error);
  }
}

/**
 * Invoca la funzione serverless su Netlify per fare il dispatch su GitHub
 * @param {string} wallet - Indirizzo wallet dell'utente
 * @param {string} updateType - "update_whitelist" oppure "update_noneligible"
 */
async function triggerWorkflow(wallet, updateType) {
  const endpoint = "https://superlative-empanada-0c1b37.netlify.app/.netlify/functions/triggerWhitelistUpdate";
  try {
    await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet, updateType })
    });
    // Non serve gestire la risposta qui, ma potresti aggiungere log
  } catch (error) {
    console.error("Error triggering workflow:", error);
  }
}